{% extends 'job_app/base.html' %}
{% load static %}
{% block content %}

<style>
  .dashboard-sidebar .profile-box img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #0d6efd;
  }

  .dashboard-sidebar .nav-link {
    color: #495057;
    border-radius: 0.5rem;
    padding: 0.6rem 0.9rem;
    font-weight: 500;
  }

  .dashboard-sidebar .nav-link:hover,
  .dashboard-sidebar .nav-link.active {
    background-color: #0d6efd;
    color: #fff !important;
  }
</style>

<div class="container-fluid">
  <div class="row flex-nowrap">

    <!-- Sidebar -->
    <nav id="sidebarMenu"
         class="col-12 col-md-3 col-lg-2 bg-white border-end min-vh-100 p-3 collapse d-md-block dashboard-sidebar">

      <!-- Profile Section -->
      <div class="d-flex align-items-center mb-4 profile-box">
        {% if user.profile.profile_image %}
          <img src="{{ user.profile.profile_image.url }}"
               alt="Profile Image"
               class="me-3">
        {% else %}
          <img src="{% static 'images/default.png' %}"
               alt="Default Image"
               class="me-3">
        {% endif %}
        <div class="text-start">
          <h5 class="mb-0">{{ user.get_full_name|default:user.username }}</h5>
          <p class="text-muted mb-0 small">{{ user.profile.get_role_display }}</p>
        </div>
      </div>

      <!-- Sidebar Menu -->
      <ul class="nav flex-column">
        <li class="nav-item mb-1">
          <a class="nav-link {% if section == 'bookings' %}active{% endif %}"
             href="{% url 'job_app:user_bookings' %}">
            My Bookings
          </a>
        </li>
        <li class="nav-item mb-1">
          <a class="nav-link {% if section == 'profile' %}active{% endif %}"
             href="{% url 'job_app:profile_settings' %}">
            Profile Settings
          </a>
        </li>
      </ul>
    </nav>

    <!-- Main content -->
    <main class="col px-3 py-4 dashboard-content">

      <!-- Mobile toggle button -->
      <button class="btn btn-outline-primary d-md-none mb-3"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#sidebarMenu"
              aria-controls="sidebarMenu"
              aria-expanded="false"
              aria-label="Toggle navigation">
        ‚ò∞ Menu
      </button>

      <!-- Main -->
      <h3 class="mb-3">Welcome Provider, {{ user.username }} üëç</h3>

      <!-- Ring Tone -->
      <audio id="ringTone" src="{% static 'sounds/ring.mp3' %}" preload="auto"></audio>

      <!-- Simple inline alert (optional) -->
      <div id="requestBox" class="alert alert-info mt-3" style="display:none;">
        <h5>New Service Request!</h5>
        <p id="reqService"></p>
        <p id="reqUser"></p>
        <p id="reqPhone"></p>
        <button id="acceptBtn" class="btn btn-success btn-sm">Accept</button>
        <button id="declineBtn" class="btn btn-danger btn-sm">Decline</button>
      </div>

      <!-- Incoming Request Modal -->
      <div class="modal fade" id="incomingRequestModal" tabindex="-1"
           aria-labelledby="incomingRequestLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">

            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="incomingRequestLabel">New Service Request</h5>
              <button type="button" class="btn-close btn-close-white"
                      data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <p><strong>Service:</strong> <span id="modalServiceTitle"></span></p>
              <p><strong>From:</strong> <span id="modalSeekerName"></span></p>
              <p><strong>Phone:</strong> <span id="modalSeekerPhone"></span></p>
              <p><strong>Location:</strong> <span id="modalSeekerLocation"></span></p>
            </div>

            <div class="modal-footer">
              <button class="btn btn-danger" onclick="declineRequest()">Decline</button>
              <button class="btn btn-success" onclick="acceptRequest()">Accept</button>
            </div>

          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="row g-3 mt-3">
        <div class="col-md-4">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <small class="text-muted text-uppercase">Total Services</small>
              <p class="fs-3 fw-semibold mb-0">{{ services.count }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <small class="text-muted text-uppercase">Total Bookings</small>
              <p class="fs-3 fw-semibold mb-0">{{ bookings.count }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Button -->
      <a href="{% url 'job_app:service_add' %}" class="btn btn-primary mt-4">
        + Add New Service
      </a>

    </main>
  </div>
</div>

<script>
const providerId = "{{ request.user.profile.id }}";
const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
const wsUrl = `${wsProtocol}://${window.location.host}/ws/notifications/${providerId}/`;

const socket = new WebSocket(wsUrl);
const ring = document.getElementById("ringTone");
let currentRequestId = null;

socket.onopen = () => console.log("WS CONNECTED");

socket.onmessage = function (e) {
  const data = JSON.parse(e.data);

  if (data.type === "send_request") {
    currentRequestId = data.request_id;

    document.getElementById("reqService").innerText = "Service: " + data.service;
    document.getElementById("reqUser").innerText = "From: " + data.seeker;
    document.getElementById("reqPhone").innerText = "Phone: " + data.phone;

    document.getElementById("requestBox").style.display = "block";

    ring.play().catch(err => console.log("Autoplay Blocked:", err));
  }
};

socket.onclose = () => console.log("WS CLOSED");

document.getElementById("acceptBtn").onclick = () => {
  if (!currentRequestId) return;

  socket.send(JSON.stringify({
    action: "accept",
    request_id: currentRequestId
  }));

  fetch("/bookings/create/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({
      request_id: currentRequestId,
      status: "accepted"
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      stopRing();
      location.reload();
    }
  });

  document.getElementById("requestBox").style.display = "none";
};

document.getElementById("declineBtn").onclick = () => {
  if (!currentRequestId) return;

  socket.send(JSON.stringify({
    action: "decline",
    request_id: currentRequestId
  }));

  stopRing();
  document.getElementById("requestBox").style.display = "none";
};

function stopRing() {
  ring.pause();
  ring.currentTime = 0;
}

function getCookie(name) {
  let cookieValue = null;
  const cookies = document.cookie ? document.cookie.split(";") : [];
  for (let cookie of cookies) {
    cookie = cookie.trim();
    if (cookie.startsWith(name + "=")) {
      cookieValue = cookie.substring(name.length + 1);
      break;
    }
  }
  return cookieValue;
}
</script>

{% endblock %}
